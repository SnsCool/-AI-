# Zoom Meeting Analysis Agent

Zoom録画を自動で取得・分析し、スプレッドシートに記録するシステムです。

---

## このシステムが何をするか

**1時間ごとに自動実行**され、以下を行います：

1. 全32名の担当者のZoom録画を取得
2. 文字起こしをGoogle Docsに保存
3. 動画をGoogle Driveにアップロード
4. 結果をスプレッドシートに記録

> **注意**: 現在、Gemini AIによる分析機能は**オフ**にしています（APIクォータ節約のため）。
> フィードバック欄は空欄になります。

---

## 処理の流れ（フローチャート）

```
┌────────────────────────────────────────────────────────────┐
│  1時間ごとに自動実行開始                                    │
└────────────────────────────────────────────────────────────┘
                              ↓
┌────────────────────────────────────────────────────────────┐
│  全32アカウントの認証情報を取得                             │
│  （Supabase → 失敗時はスプレッドシート「ZoomKeys」）        │
└────────────────────────────────────────────────────────────┘
                              ↓
┌────────────────────────────────────────────────────────────┐
│  各アカウントでZoom APIから過去1ヶ月の録画を取得            │
│  → 最新1件のみを処理対象とする                             │
└────────────────────────────────────────────────────────────┘
                              ↓
┌────────────────────────────────────────────────────────────┐
│  【チェック1】この録画は処理済み？                          │
│                                                            │
│  YES → この録画はスキップ、次のアカウントへ                │
│  NO  → 処理を続ける                                        │
└────────────────────────────────────────────────────────────┘
                              ↓
┌────────────────────────────────────────────────────────────┐
│  【チェック2】顧客管理シートと照合                          │
│                                                            │
│  担当者名 ＋ 面談時間（±45分以内）で検索                   │
│                                                            │
│  マッチあり → 顧客名とステータスを取得                     │
│  マッチなし → Zoomの会議名を顧客名として使用               │
└────────────────────────────────────────────────────────────┘
                              ↓
┌────────────────────────────────────────────────────────────┐
│  【チェック3】G列（事前キャンセル）のステータスで分岐       │
│                                                            │
│  「事前キャンセル」「担当者変更」「重複予約」               │
│    → この録画は処理不要、スキップ                          │
│                                                            │
│  「着座」「飛び」                                           │
│    → 処理する、完了後に「処理済み」マークを付ける          │
│    → 次回以降は再処理されない                              │
│                                                            │
│  それ以外（空欄、リスケ等）                                 │
│    → 処理する、「処理済み」マークは付けない                │
│    → ステータスが更新されたら再処理される                  │
└────────────────────────────────────────────────────────────┘
                              ↓
┌────────────────────────────────────────────────────────────┐
│  文字起こし（VTTファイル）をダウンロード                    │
│  → Google Docsに保存                                       │
└────────────────────────────────────────────────────────────┘
                              ↓
┌────────────────────────────────────────────────────────────┐
│  動画をダウンロード                                         │
│  → Google Driveにアップロード                              │
└────────────────────────────────────────────────────────────┘
                              ↓
┌────────────────────────────────────────────────────────────┐
│  【書き込み先の決定】                                       │
│                                                            │
│  ■ Zoom相談一覧シート                                      │
│    → 顧客管理シートにマッチした場合のみ書き込む            │
│                                                            │
│  ■ データ格納シート                                        │
│    → すべての録画を書き込む（履歴保存用）                  │
│    → 担当者＋面談日時が同じなら重複とみなしスキップ        │
└────────────────────────────────────────────────────────────┘
                              ↓
┌────────────────────────────────────────────────────────────┐
│  次のアカウントへ → 全アカウント完了で終了                  │
└────────────────────────────────────────────────────────────┘
```

---

## ルールまとめ

### 処理対象

| 条件 | 処理 |
|------|------|
| 過去1ヶ月以内の録画 | 対象 |
| 各アカウントの最新1件 | 対象 |
| すでに処理済みの録画 | スキップ |

### ステータスによる処理分岐

| G列ステータス | 処理する？ | 処理済みマーク | 再処理される？ |
|--------------|-----------|---------------|---------------|
| 着座 | する | 付ける | されない |
| 飛び | する | 付ける | されない |
| リスケ・日程調整済 | する | 付けない | される |
| 空欄 | する | 付けない | される |
| 事前キャンセル | しない | - | - |
| 担当者変更 | しない | - | - |
| 重複予約 | しない | - | - |

### 書き込み先

| シート名 | 書き込み条件 | 重複チェック |
|---------|-------------|-------------|
| Zoom相談一覧 | 顧客管理シートにマッチした場合のみ | なし（更新する） |
| データ格納 | すべての録画 | あり（担当者＋面談日時） |

---

## 出力先シート

**Zoom相談一覧シート**: https://docs.google.com/spreadsheets/d/1R5oMbJ7E-QfDFhHR164y8JKs6XLnkJcw8zBm2IPSn8E

| 列 | 内容 |
|----|------|
| A | 顧客名 |
| B | 担当者 |
| C | 面談日時 |
| D | 所要時間 |
| E | 事前キャンセル（着座/飛び/リスケ等） |
| F | 初回/実施後ステータス（成約/失注/保留等） |
| G | 文字起こし（Google Docsリンク） |
| H | 面談動画（Google Driveリンク） |
| I | フィードバック |

---

## 実行タイミング

- **自動実行**: 毎時0分（1時間ごと）
- **処理時間**: 約7〜10分で完了
- **対象**: 全32アカウント

---

## よくある質問

### Q. 録画がシートに反映されない

以下を確認してください：
1. Zoomでクラウド録画が有効になっているか
2. 顧客管理シートに該当の予定が登録されているか
3. G列ステータスが「事前キャンセル」等になっていないか

### Q. 同じ録画が何度も処理される

G列ステータスが「着座」「飛び」以外の場合、処理済みマークが付かないため再処理されます。これは仕様です（ステータス更新後に再処理するため）。

### Q. 動画が見れない

Google Driveで「Video Player for Google Drive」アプリを使用すると、処理待ちなしで即座に再生できます。

---

## 技術情報（エンジニア向け）

### アーキテクチャ

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   Zoom API      │────▶│   Gemini AI     │────▶│ Google Sheets   │
│  (録画取得)      │     │   (分析)         │     │   (出力)        │
└─────────────────┘     └─────────────────┘     └─────────────────┘
         │                                               │
         ▼                                               ▼
┌─────────────────┐                           ┌─────────────────┐
│   Supabase      │                           │  Google Drive   │
│ (認証情報/履歴)  │                           │ (文字起こし/動画) │
└─────────────────┘                           └─────────────────┘
```

### 環境変数

| 変数名 | 説明 |
|--------|------|
| `SUPABASE_URL` | Supabase URL |
| `SUPABASE_ANON_KEY` | Supabase Anonymous Key |
| `SUPABASE_SERVICE_ROLE_KEY` | Supabase Service Role Key |
| `GEMINI_API_KEY` | Google Gemini API Key |
| `GOOGLE_CREDENTIALS_JSON` | Google サービスアカウント認証情報（JSON） |
| `GOOGLE_SPREADSHEET_ID` | 出力先スプレッドシートID |
| `GOOGLE_DRIVE_FOLDER_ID` | Google Drive保存先フォルダID |
| `GAS_WEBAPP_URL` | Google Apps Script Web App URL |

### ファイル構成

```
zoom/
├── batch_zoom.py          # メインバッチ処理スクリプト
├── main.py                # 単体実行用
├── requirements.txt       # Python依存パッケージ
└── services/
    ├── zoom_client.py     # Zoom API クライアント
    ├── gemini_client.py   # Gemini AI クライアント
    ├── sheets_client.py   # Google Sheets クライアント
    ├── supabase_client.py # Supabase クライアント
    └── google_drive_client.py # Google Drive クライアント
```

### 手動実行

```bash
# 全アカウント処理
python batch_zoom.py

# テスト実行（書き込みなし）
python batch_zoom.py --dry-run

# 特定グループのみ処理
python batch_zoom.py --group 1
```

### Zoom認証情報の更新

Zoom Marketplace (https://marketplace.zoom.us/) で Server-to-Server OAuth アプリの認証情報を確認・更新してください。

### トラブルシューティング

| エラー | 原因 | 対処法 |
|--------|------|--------|
| 認証エラー | Zoom認証情報が古い | ZoomKeysシートを確認 |
| タイムアウト | 処理が60分超過 | 通常は発生しない |
| 429エラー | Zoom API制限 | 自動リトライで解決 |
