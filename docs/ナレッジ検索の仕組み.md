# ナレッジ検索の仕組み

## これは何？

Notionに保存されている2,927件のドキュメントを、**自然な言葉で検索できる仕組み**です。

---

## 今までの問題

```
あなた：「入学式でZoomどうやって設定する？」

→ 2,927ファイルの中から自分で探す
→ どこに書いてあるか分からない
→ 見つけるのに時間がかかる
```

---

## ナレッジ検索を使うと

```
あなた：「入学式でZoomどうやって設定する？」

→ AIが自動で関連する部分を見つける
→ 「CS部/入学式マニュアル」から回答
→ 「待機室から入室を許可して、生徒を入室させてください」
```

**普通の言葉で質問するだけで、答えが見つかります。**

---

## 仕組み（3ステップ）

### ステップ1：チャンク化（文章を分ける）

長いマニュアルを、**話題ごとに分けます**。

**例：入学式マニュアルの場合**

| 分ける前 | 分けた後（チャンク） |
|---------|---------------------|
| 入学式マニュアル全体（10ページ） | ① 全体の流れ |
| | ② Zoomの準備方法 |
| | ③ はじめの挨拶 |
| | ④ ポータルの説明 |
| | ⑤ グループセッション |

**なぜ分けるの？**
→ 質問に関係ある部分だけ取り出すため

---

### ステップ2：数値に変換（ベクトル化）

文章をAIが理解できる**数値の列**に変換します。

```
「Zoomを立ち上げて画面共有する」
        ↓
[0.023, -0.041, 0.089, 0.012, ...]  ← 1536個の数字
```

**なぜ数値にするの？**
→ 似ている文章を計算で見つけられるようになる

---

### ステップ3：似ている文章を探す

質問も数値に変換して、**似ている数値を探します**。

```
質問：「Zoomの設定方法は？」
        ↓
[0.021, -0.038, 0.092, 0.015, ...]
        ↓
保存されている数値と比較
        ↓
一番似ている → チャンク②「Zoomを立ち上げて画面共有する」
```

---

## 図でまとめると

```
┌─────────────────────────────────────────────────────┐
│                    準備（1回だけ）                    │
├─────────────────────────────────────────────────────┤
│                                                      │
│   Notionドキュメント                                  │
│   （2,927ファイル）                                   │
│         ↓                                            │
│   チャンク化（話題ごとに分ける）                       │
│         ↓                                            │
│   数値に変換                                          │
│         ↓                                            │
│   データベースに保存（Supabase）                      │
│                                                      │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│                    検索（毎回）                       │
├─────────────────────────────────────────────────────┤
│                                                      │
│   あなたの質問                                        │
│   「クレーム対応どうする？」                          │
│         ↓                                            │
│   質問を数値に変換                                    │
│         ↓                                            │
│   似ている文章を探す                                  │
│         ↓                                            │
│   関連するチャンクを取得                              │
│         ↓                                            │
│   AIが回答を生成                                      │
│                                                      │
└─────────────────────────────────────────────────────┘
```

---

## 自然言語検索にはこれがおすすめ

| 方法 | おすすめ度 | 理由 |
|------|-----------|------|
| **RAG + Supabase** | ★★★ | 既にSupabaseを使っている。追加費用ほぼなし |
| Elasticsearch | ★★☆ | 高機能だが、別途サーバーが必要 |
| Algolia | ★★☆ | 簡単だが、月額費用がかかる |

**結論：Supabase + OpenAI の組み合わせが最適**

- 初期費用：約14円（Embedding生成）
- 月額費用：無料（Supabase無料枠内）
- 検索速度：高速（ミリ秒単位）

---

## 用語まとめ

| 用語 | 意味 |
|------|------|
| チャンク | 長い文章を分けた「かたまり」 |
| ベクトル | 文章を数値の列に変換したもの |
| Embedding | ベクトルに変換すること |
| RAG | 検索して関連情報を取得し、AIが回答する仕組み |
| pgvector | Supabaseでベクトル検索ができる機能 |

---

## 次のステップ

1. OpenAI APIキーを用意する
2. Supabaseでpgvectorを有効にする
3. ドキュメントをチャンク化してEmbedding生成
4. 検索機能を作成

**準備ができたら、構築を開始します。**
