# X Trend Video Fetcher & Mimic Post Generator
# Daily automated workflow

name: Daily X Trend Agent

on:
  # Scheduled execution: Every day at 0:00 UTC (9:00 JST)
  schedule:
    - cron: '0 0 * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      test_x_posting:
        description: 'Test X posting (text only)'
        required: false
        type: boolean
        default: false

jobs:
  fetch-and-generate:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # Step 3: Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Step 4: Create service account key file from secret
      - name: Setup Google Cloud credentials
        run: |
          echo "${{ secrets.GCP_SA_KEY_JSON }}" > service_account.json
        env:
          GCP_SA_KEY_JSON: ${{ secrets.GCP_SA_KEY_JSON }}

      # Step 5a: Test X posting (if requested)
      - name: Test X Posting
        if: ${{ github.event.inputs.test_x_posting == 'true' }}
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}
        run: |
          python main.py --test-x

      # Step 5b: Run the main script (if not testing)
      - name: Run X Trend Agent
        if: ${{ github.event.inputs.test_x_posting != 'true' }}
        env:
          APIFY_TOKEN: ${{ secrets.APIFY_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
          GCP_SA_KEY_JSON: ${{ secrets.GCP_SA_KEY_JSON }}
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}
          ENABLE_X_POSTING: 'false'
        run: |
          python main.py

      # Step 6: Cleanup sensitive files
      - name: Cleanup
        if: always()
        run: |
          rm -f service_account.json
          echo "Cleanup completed"
