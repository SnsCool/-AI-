# Sales Feedback Agent（営業フィードバックエージェント）仕様書

## 1. 概要

### 1.1 目的
Zoom営業会議の議事録・録画を分析し、営業担当者にフィードバックを提供するエージェント。
クロージング成功事例をナレッジとして蓄積し、チーム全体の営業力向上を支援する。

### 1.2 エージェント分類
- **タイプ**: judgment（判断系）
- **エージェント名**: `sales_feedback`
- **役割**: 営業会議の分析・評価・フィードバック生成

### 1.3 技術基盤
- **RAGFlow**: ナレッジ管理・検索エンジン（オープンソース）
- **Docker**: コンテナ化された環境
- **Gemini API**: AI分析・評価生成

---

## 2. 機能要件

### 2.1 入力データ対応

| 入力形式 | 説明 | 処理方法 |
|---------|------|---------|
| テキスト議事録 | Zoom/手動作成の議事録 | RAGFlowに直接登録 |
| PDF/Word | ドキュメント形式 | RAGFlowが自動解析 |
| 音声ファイル | mp3, wav, m4a | Speech-to-Text後にRAGFlow登録 |
| 動画ファイル | mp4, webm | 音声抽出→文字起こし→RAGFlow登録 |

### 2.2 分析機能

#### A. 会話分析
- **話者分離**: 営業担当 vs 顧客の発言を識別
- **発話比率**: 営業側/顧客側の発話時間・量を計測
- **質問分析**: 質問の数・質・タイミングを評価
- **傾聴度**: 顧客の話を遮っていないかチェック

#### B. 営業スキル評価

| 評価項目 | 評価基準 |
|---------|---------|
| ヒアリング力 | 課題・ニーズを引き出せているか |
| 提案力 | 顧客課題に対する解決策を適切に提示 |
| 異議対応 | 顧客の懸念・反論への対応品質 |
| クロージング | 次のアクション・契約への導き方 |
| ラポール構築 | 信頼関係の構築度合い |
| BANT確認 | Budget/Authority/Need/Timelineの確認 |

#### C. フィードバック生成
- **良かった点**: 具体的な発言・行動を引用
- **改善点**: 具体的な改善提案と代替案
- **スコアリング**: 各項目を5段階評価
- **総合評価**: 全体サマリーと優先改善ポイント

### 2.3 ナレッジ蓄積機能（RAGFlow）

#### クロージング成功事例の蓄積
```
【蓄積データ】
- 商談概要（業種、商材、商談フェーズ）
- 成功要因の分析結果
- 効果的だったフレーズ・対応
- 顧客の反応パターン
- 担当者・チーム
- 日時
```

#### RAGFlowによるナレッジ活用
- 類似商談の成功事例を自然言語で検索
- 業種・商材別のベストプラクティス抽出
- チャット形式での質問応答

---

## 3. システム構成（RAGFlow版）

### 3.1 アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────────┐
│                        Input Sources                             │
├─────────────────────────────────────────────────────────────────┤
│  📄 議事録   │  📑 PDF/Word  │  🎤 音声    │  🎥 動画          │
└──────┬───────┴───────┬───────┴──────┬──────┴───────┬────────────┘
       │               │              │              │
       │               │              ▼              ▼
       │               │       ┌─────────────────────────┐
       │               │       │   前処理（Phase 2以降）   │
       │               │       │  ┌───────┐  ┌────────┐ │
       │               │       │  │FFmpeg │→│AssemblyAI│ │
       │               │       │  └───────┘  └────────┘ │
       │               │       └───────────┬─────────────┘
       │               │                   │
       ▼               ▼                   ▼
┌─────────────────────────────────────────────────────────────────┐
│                         RAGFlow                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                  Document Processing                     │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐             │    │
│  │  │ドキュメント│→│  チャンク │→│ベクトル化 │             │    │
│  │  │   解析   │  │   分割   │  │(Embedding)│             │    │
│  │  └──────────┘  └──────────┘  └──────────┘             │    │
│  └─────────────────────────────────────────────────────────┘    │
│                            │                                     │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                   Storage Layer                          │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐             │    │
│  │  │  MySQL   │  │Elasticsearch│ │  MinIO   │             │    │
│  │  │(メタデータ)│  │(全文検索) │  │(ファイル)│             │    │
│  │  └──────────┘  └──────────┘  └──────────┘             │    │
│  └─────────────────────────────────────────────────────────┘    │
│                            │                                     │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                   AI Analysis                            │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐             │    │
│  │  │ ハイブリッド│→│コンテキスト│→│  Gemini  │             │    │
│  │  │   検索   │  │   構築   │  │   分析   │             │    │
│  │  └──────────┘  └──────────┘  └──────────┘             │    │
│  └─────────────────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────────────────┘
                       │
        ┌──────────────┼──────────────┐
        ▼              ▼              ▼
┌───────────┐  ┌───────────┐  ┌───────────┐
│  Web UI   │  │    API    │  │  Slack    │
│ (管理画面) │  │ (連携用)  │  │  (通知)   │
└───────────┘  └───────────┘  └───────────┘
```

### 3.2 コンポーネント構成

| コンポーネント | 役割 | ポート |
|--------------|------|-------|
| RAGFlow | メインアプリケーション | 8080 |
| MySQL | メタデータ管理 | 3306 |
| Redis | キャッシュ・セッション | 6379 |
| Elasticsearch | 全文検索 | 9200 |
| MinIO | ファイルストレージ | 9000/9001 |

### 3.3 データフロー

```
1. ドキュメント登録
   └→ RAGFlow Web UI または API でアップロード
   └→ 自動で解析・チャンク分割・ベクトル化

2. 分析リクエスト
   └→ チャット形式で質問
   └→ 関連ドキュメントを自動検索
   └→ Gemini が分析・フィードバック生成

3. ナレッジ検索
   └→ 「IT業界での成功事例は？」などの自然言語クエリ
   └→ ハイブリッド検索（ベクトル + キーワード）
   └→ 関連する成功事例を返却

4. API連携（エージェントシステム）
   └→ SalesFeedbackAgent が RAGFlow API を呼び出し
   └→ 結果を整形して返却
```

---

## 4. 必要なAPI

### 4.1 RAGFlow（コア機能）- 自前ホスト

| 機能 | エンドポイント | 用途 |
|-----|--------------|------|
| ナレッジベース作成 | `POST /api/v1/datasets` | 営業ナレッジDB作成 |
| ドキュメント登録 | `POST /api/v1/datasets/{id}/documents` | 議事録アップロード |
| チャット | `POST /api/v1/chats/{id}/completions` | 分析・質問応答 |

### 4.2 外部API

| API | 用途 | 必須度 |
|-----|------|-------|
| **Google Gemini API** | AI分析（RAGFlow内で使用） | 必須 |
| **AssemblyAI** | 音声文字起こし（Phase 2） | オプション |
| **Slack API** | 通知連携 | オプション |

---

## 5. ディレクトリ構成

```
sales_feedback/
├── docker-compose.yml      # RAGFlow + 関連サービス
├── .env.example            # 環境変数テンプレート
├── .env                    # 環境変数（自動生成）
├── setup.sh                # セットアップスクリプト
├── uploads/                # アップロードファイル
├── logs/                   # ログ
└── README.md               # 使用方法

x/agents/judgment/
├── sales_feedback_spec.md  # この仕様書
└── sales_feedback.py       # エージェント実装（予定）
```

---

## 6. 実装計画

### Phase 1: RAGFlow基盤構築 ✅
- [x] Docker Compose構成作成
- [x] セットアップスクリプト作成
- [x] 環境変数設定
- [x] README作成

### Phase 2: 基本機能
- [ ] RAGFlowの起動・初期設定
- [ ] ナレッジベース「sales_knowledge」作成
- [ ] サンプル議事録のアップロード・テスト
- [ ] 評価用プロンプトの設定

### Phase 3: エージェント連携
- [ ] SalesFeedbackAgent実装
- [ ] RAGFlow APIクライアント作成
- [ ] CommanderAgentとの連携

### Phase 4: 音声・動画対応
- [ ] AssemblyAI連携
- [ ] 音声ファイル自動文字起こし
- [ ] 動画ファイル対応

### Phase 5: 通知・自動化
- [ ] Slack通知連携
- [ ] Zoom Webhook対応（会議終了時自動分析）

---

## 7. 環境変数

```env
# RAGFlow
RAGFLOW_PORT=8080
RAGFLOW_API_KEY=ragflow-xxxxx  # Web UIで生成

# データベース
MYSQL_PASSWORD=xxxxx

# ストレージ
MINIO_USER=minioadmin
MINIO_PASSWORD=xxxxx

# LLM（RAGFlow内で使用）
GEMINI_API_KEY=xxxxx

# 音声文字起こし（Phase 4）
ASSEMBLYAI_API_KEY=xxxxx

# 通知（Phase 5）
SLACK_BOT_TOKEN=xoxb-xxxxx
```

---

## 8. エージェント能力定義

```python
class SalesFeedbackAgent(BaseAgent):
    """
    営業フィードバックエージェント

    RAGFlowと連携して営業会議を分析し、
    フィードバックを生成する。
    """

    def __init__(self):
        super().__init__()
        self.ragflow_url = os.getenv("RAGFLOW_URL", "http://localhost:8080")
        self.ragflow_api_key = os.getenv("RAGFLOW_API_KEY")
        self.dataset_id = os.getenv("RAGFLOW_DATASET_ID")

    @property
    def name(self) -> str:
        return "sales_feedback"

    @property
    def description(self) -> str:
        return "営業フィードバックエージェント - RAGFlowを使用して会議を分析"

    @property
    def agent_type(self) -> str:
        return "judgment"

    def get_capabilities(self) -> list[str]:
        return [
            "analyze_sales_meeting",      # 営業会議分析
            "evaluate_sales_skills",      # 営業スキル評価
            "generate_feedback",          # フィードバック生成
            "store_knowledge",            # ナレッジ蓄積
            "search_best_practices",      # ベストプラクティス検索
        ]

    def can_handle(self, request: str) -> bool:
        keywords = [
            "営業", "商談", "会議", "議事録", "zoom",
            "フィードバック", "評価", "分析", "クロージング",
            "ナレッジ", "成功事例"
        ]
        return any(kw in request.lower() for kw in keywords)

    def upload_document(self, file_path: str) -> dict:
        """議事録をRAGFlowにアップロード"""
        # RAGFlow API呼び出し
        pass

    def analyze_meeting(self, query: str) -> dict:
        """会議を分析してフィードバック生成"""
        # RAGFlow Chat API呼び出し
        pass

    def search_knowledge(self, query: str) -> list:
        """成功事例を検索"""
        # RAGFlow検索API呼び出し
        pass
```

---

## 9. 評価プロンプト（RAGFlow設定用）

```
あなたは経験豊富な営業マネージャーです。
アップロードされた商談議事録を分析し、以下の観点でフィードバックしてください。

【評価項目】
1. ヒアリング力（1-5点）
   - 顧客の課題・ニーズを適切に引き出せているか

2. 提案力（1-5点）
   - 課題に対する解決策を適切に提示できているか

3. 異議対応（1-5点）
   - 顧客の懸念・反論に適切に対応できているか

4. クロージング（1-5点）
   - 次のアクションへ適切に導けているか

5. ラポール構築（1-5点）
   - 信頼関係を構築できているか

6. BANT確認（1-5点）
   - Budget/Authority/Need/Timelineを確認できているか

【出力形式】
以下の形式で回答してください：

## 総合スコア: X.X / 5.0

### 各項目評価
| 項目 | スコア | 理由 |
|-----|-------|------|
| ヒアリング力 | X | ... |
| 提案力 | X | ... |
| 異議対応 | X | ... |
| クロージング | X | ... |
| ラポール構築 | X | ... |
| BANT確認 | X | ... |

### 良かった点
- ...
- ...

### 改善点
- ...
- ...

### 効果的だったフレーズ
> "..."

### 次回へのアドバイス
1. ...
2. ...
3. ...
```

---

## 10. コスト比較

### 旧構成（Qdrant + Notion + 自前実装）
| サービス | 月額 |
|---------|------|
| AssemblyAI | ~$45 |
| Gemini API | ~$10 |
| Qdrant Cloud | ~$25 |
| **合計** | **~$80** |

### RAGFlow構成（セルフホスト）
| サービス | 月額 |
|---------|------|
| AssemblyAI | ~$45 |
| Gemini API | ~$10 |
| サーバー（自前） | $0 |
| **合計** | **~$55** |

→ **月額約$25のコスト削減 + 管理画面付き**

---

## 11. クイックスタート

```bash
# 1. ディレクトリ移動
cd sales_feedback

# 2. セットアップ実行
./setup.sh

# 3. ブラウザでアクセス
open http://localhost:8080

# 4. 初期設定
#    - アカウント作成
#    - Model Providers で Gemini API キー設定
#    - ナレッジベース「sales_knowledge」作成
#    - 議事録をアップロード
```

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025-12-30 | 0.1.0 | 初版作成 |
| 2025-12-30 | 0.2.0 | RAGFlow版に全面改訂 |
