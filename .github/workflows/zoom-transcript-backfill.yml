# Zoom文字起こしバックフィル（自動）
# G列に文字起こしDocsがない行を定期チェックし、VTT or Groq Whisperで文字起こしを作成
name: Zoom Transcript Backfill

on:
  schedule:
    # 30分おきに実行
    - cron: '*/30 * * * *'
  workflow_dispatch:  # 手動実行も可能

env:
  TZ: 'Asia/Tokyo'

jobs:
  backfill:
    name: Create Missing Transcripts
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            zoom
            .github
          sparse-checkout-cone-mode: false

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('zoom/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r zoom/requirements.txt

      - name: Install ffmpeg
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq ffmpeg

      - name: Setup Google Credentials
        env:
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
        run: |
          umask 077
          if printf '%s' "$GOOGLE_CREDENTIALS_JSON" | base64 -d > /tmp/google_creds.json 2>/dev/null; then
            echo "Credentials decoded from base64."
          else
            printf '%s' "$GOOGLE_CREDENTIALS_JSON" > /tmp/google_creds.json
            echo "Credentials saved as raw JSON."
          fi
          chmod 600 /tmp/google_creds.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/google_creds.json" >> $GITHUB_ENV

      - name: Create Missing Transcripts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          GAS_WEBAPP_URL: ${{ secrets.GAS_WEBAPP_URL }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          PYTHONUNBUFFERED: "1"
        run: |
          echo "=== 文字起こしバックフィル（VTT + Groq Whisper） ==="
          python zoom/batch_zoom.py --create-missing-transcripts

      - name: Cleanup
        if: always()
        run: |
          rm -f /tmp/google_creds.json

  notify:
    name: Notify Results
    needs: backfill
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          LOG_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          CURRENT_TIME=$(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')
          MENTION="<@1340666940615823451>"

          if [ "${{ needs.backfill.result }}" == "success" ]; then
            TITLE="Transcript Backfill"
            DESCRIPTION="文字起こしバックフィルが完了しました。"
            COLOR=3066993
          elif [ "${{ needs.backfill.result }}" == "failure" ]; then
            TITLE="Transcript Backfill Error"
            DESCRIPTION="文字起こしバックフィルでエラーが発生しました。"
            COLOR=15158332
          else
            TITLE="Transcript Backfill Skip"
            DESCRIPTION="文字起こし対象がありませんでした。"
            COLOR=8421504
          fi

          curl -X POST -H 'Content-Type: application/json' \
            --data "{
              \"content\": \"${MENTION}\",
              \"embeds\": [{
                \"title\": \"${TITLE}\",
                \"description\": \"${DESCRIPTION}\\n\\n[Details](${LOG_URL})\",
                \"color\": ${COLOR},
                \"fields\": [
                  {\"name\": \"Time\", \"value\": \"${CURRENT_TIME}\", \"inline\": true},
                  {\"name\": \"Trigger\", \"value\": \"${{ github.event_name }}\", \"inline\": true}
                ],
                \"footer\": {\"text\": \"Run ID: ${{ github.run_id }}\"}
              }]
            }" \
            $DISCORD_WEBHOOK_URL
