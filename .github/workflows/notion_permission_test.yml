name: Notion Permission Test

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/notion_permission_test.yml'

jobs:
  test-notion-permissions:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Test Notion API Authentication
        env:
          NOTION_API_TOKEN: ${{ secrets.NOTION_API_TOKEN }}
        run: |
          python3 << 'EOF'
          import urllib.request
          import json
          import os

          token = os.environ.get('NOTION_API_TOKEN')
          if not token:
              print("ERROR: NOTION_API_TOKEN not found in secrets")
              exit(1)

          # Test authentication
          print("=== Testing Notion API Authentication ===\n")

          headers = {
              "Authorization": f"Bearer {token}",
              "Content-Type": "application/json",
              "Notion-Version": "2022-06-28"
          }

          # Get user info
          req = urllib.request.Request(
              "https://api.notion.com/v1/users/me",
              headers=headers,
              method='GET'
          )

          try:
              with urllib.request.urlopen(req) as response:
                  user_info = json.loads(response.read().decode('utf-8'))
                  print(f"Authentication SUCCESS!")
                  print(f"Bot Name: {user_info.get('name', 'N/A')}")
                  print(f"Workspace: {user_info.get('bot', {}).get('workspace_name', 'N/A')}")
                  print()
          except urllib.error.HTTPError as e:
              print(f"Authentication FAILED: {e.code} - {e.read().decode('utf-8')}")
              exit(1)

          # Test search permissions
          print("=== Testing Search Permissions ===\n")

          url = "https://api.notion.com/v1/search"
          all_results = []
          start_cursor = None

          while True:
              body = {"page_size": 100}
              if start_cursor:
                  body["start_cursor"] = start_cursor

              data = json.dumps(body).encode('utf-8')
              req = urllib.request.Request(url, data=data, headers=headers, method='POST')

              with urllib.request.urlopen(req) as response:
                  result = json.loads(response.read().decode('utf-8'))
                  all_results.extend(result.get('results', []))

                  if not result.get('has_more', False):
                      break
                  start_cursor = result.get('next_cursor')

          pages = [r for r in all_results if r['object'] == 'page']
          databases = [r for r in all_results if r['object'] == 'database']

          print(f"Total Accessible Items: {len(all_results)}")
          print(f"  - Pages: {len(pages)}")
          print(f"  - Databases: {len(databases)}")
          print()

          # List all databases
          print("=== Accessible Databases ===")
          for db in databases:
              title = ""
              if db.get('title'):
                  title = "".join([t.get('plain_text', '') for t in db['title']])
              print(f"  - {title or 'Untitled'} (ID: {db['id'][:8]}...)")

          print()
          print("=== Permission Test PASSED ===")
          EOF
