# Zoom ãƒãƒƒã‚¯ãƒ•ã‚£ãƒ«å‡¦ç†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# æ–‡å­—èµ·ã“ã—Docsä½œæˆãƒ»å‹•ç”»Driveã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®æœªå‡¦ç†åˆ†ã‚’è£œå®Œ
name: Zoom Backfill (Docs & Drive)

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'å‡¦ç†ãƒ¢ãƒ¼ãƒ‰'
        required: true
        type: choice
        options:
          - both
          - transcripts-only
          - videos-only
        default: 'both'

env:
  TZ: 'Asia/Tokyo'

jobs:
  backfill:
    name: Backfill ${{ inputs.mode }}
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            zoom
            .github
          sparse-checkout-cone-mode: false

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('zoom/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r zoom/requirements.txt

      - name: Setup Google Credentials
        env:
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
        run: |
          umask 077
          if printf '%s' "$GOOGLE_CREDENTIALS_JSON" | base64 -d > /tmp/google_creds.json 2>/dev/null; then
            echo "Credentials decoded from base64."
          else
            printf '%s' "$GOOGLE_CREDENTIALS_JSON" > /tmp/google_creds.json
            echo "Credentials saved as raw JSON."
          fi
          chmod 600 /tmp/google_creds.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/google_creds.json" >> $GITHUB_ENV

      - name: Create Missing Transcripts
        if: inputs.mode == 'both' || inputs.mode == 'transcripts-only'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          PYTHONUNBUFFERED: "1"
        run: |
          echo "=== æ–‡å­—èµ·ã“ã—Docsä½œæˆï¼ˆæœªå‡¦ç†åˆ†ï¼‰ ==="
          python zoom/batch_zoom.py --create-missing-transcripts

      - name: Upload Videos to Drive
        if: inputs.mode == 'both' || inputs.mode == 'videos-only'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
          PYTHONUNBUFFERED: "1"
        run: |
          echo "=== å‹•ç”»Driveã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆæœªå‡¦ç†åˆ†ï¼‰ ==="
          python zoom/batch_zoom.py --upload-videos-to-drive

      - name: Cleanup
        if: always()
        run: |
          rm -f /tmp/google_creds.json

  notify:
    name: Notify Results
    needs: backfill
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          LOG_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          CURRENT_TIME=$(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')

          if [ "${{ needs.backfill.result }}" == "success" ]; then
            TITLE="âœ… Zoom Backfill å®Œäº†"
            DESCRIPTION="Docsä½œæˆãƒ»å‹•ç”»Driveã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸã€‚"
            COLOR=3066993
          else
            TITLE="âŒ Zoom Backfill ã‚¨ãƒ©ãƒ¼"
            DESCRIPTION="ãƒãƒƒã‚¯ãƒ•ã‚£ãƒ«å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"
            COLOR=15158332
          fi

          MENTION="<@1340666940615823451>"

          curl -X POST -H 'Content-Type: application/json' \
            --data "{
              \"content\": \"${MENTION}\",
              \"embeds\": [{
                \"title\": \"${TITLE}\",
                \"description\": \"${DESCRIPTION}\\n\\n**ãƒ¢ãƒ¼ãƒ‰:** ${{ inputs.mode }}\\n[ğŸ“‹ è©³ç´°ãƒ­ã‚°ã‚’ç¢ºèª](${LOG_URL})\",
                \"color\": ${COLOR},
                \"fields\": [
                  {\"name\": \"å®Ÿè¡Œæ™‚åˆ»\", \"value\": \"${CURRENT_TIME}\", \"inline\": true},
                  {\"name\": \"ãƒ¢ãƒ¼ãƒ‰\", \"value\": \"${{ inputs.mode }}\", \"inline\": true}
                ],
                \"footer\": {\"text\": \"Run ID: ${{ github.run_id }}\"}
              }]
            }" \
            $DISCORD_WEBHOOK_URL
