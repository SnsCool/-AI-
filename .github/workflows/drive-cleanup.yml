# ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ Drive ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
# GASçµŒç”±ã‚³ãƒ”ãƒ¼å¾Œã«æ®‹ã£ãŸä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®šæœŸå‰Šé™¤
name: Drive Cleanup

on:
  schedule:
    - cron: '0 15 * * *'  # æ¯æ—¥ 0:00 JST
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼ˆä¸€è¦§è¡¨ç¤ºã®ã¿ï¼‰'
        required: false
        type: boolean
        default: true
      older_than:
        description: 'Næ™‚é–“ä»¥ä¸Šå‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¯¾è±¡'
        required: false
        type: number
        default: 1

env:
  TZ: 'Asia/Tokyo'

jobs:
  cleanup:
    name: Cleanup Service Account Drive
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            zoom
          sparse-checkout-cone-mode: false

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('zoom/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r zoom/requirements.txt

      - name: Setup Google Credentials
        env:
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
        run: |
          umask 077
          if printf '%s' "$GOOGLE_CREDENTIALS_JSON" | base64 -d > /tmp/google_creds.json 2>/dev/null; then
            echo "Credentials decoded from base64."
          else
            printf '%s' "$GOOGLE_CREDENTIALS_JSON" > /tmp/google_creds.json
            echo "Credentials saved as raw JSON."
          fi
          chmod 600 /tmp/google_creds.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/google_creds.json" >> $GITHUB_ENV

      - name: Run Cleanup
        id: cleanup
        env:
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
          PYTHONUNBUFFERED: "1"
        run: |
          FLAGS=""
          if [ "${{ github.event_name }}" == "schedule" ]; then
            # cron: å®Ÿå‰Šé™¤
            FLAGS="--older-than 1"
          else
            # æ‰‹å‹•
            if [ "${{ inputs.dry_run }}" == "true" ]; then
              FLAGS="--dry-run"
            fi
            FLAGS="$FLAGS --older-than ${{ inputs.older_than || 1 }}"
          fi

          echo "=== Drive Cleanup ==="
          echo "ãƒ•ãƒ©ã‚°: $FLAGS"
          python zoom/cleanup_drive.py $FLAGS 2>&1 | tee /tmp/cleanup_output.txt

      - name: Cleanup
        if: always()
        run: |
          rm -f /tmp/google_creds.json

  notify:
    name: Notify Results
    needs: cleanup
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          LOG_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          CURRENT_TIME=$(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')

          if [ "${{ needs.cleanup.result }}" == "success" ]; then
            TITLE="âœ… Drive Cleanup å®Œäº†"
            DESCRIPTION="ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸã€‚"
            COLOR=3066993
          else
            TITLE="âŒ Drive Cleanup ã‚¨ãƒ©ãƒ¼"
            DESCRIPTION="ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"
            COLOR=15158332
          fi

          MENTION="<@1340666940615823451>"

          curl -s -X POST -H 'Content-Type: application/json' \
            --data "{
              \"content\": \"${MENTION}\",
              \"embeds\": [{
                \"title\": \"${TITLE}\",
                \"description\": \"${DESCRIPTION}\\n\\n[ğŸ“‹ è©³ç´°ãƒ­ã‚°ã‚’ç¢ºèª](${LOG_URL})\",
                \"color\": ${COLOR},
                \"fields\": [
                  {\"name\": \"å®Ÿè¡Œæ™‚åˆ»\", \"value\": \"${CURRENT_TIME}\", \"inline\": true},
                  {\"name\": \"ãƒˆãƒªã‚¬ãƒ¼\", \"value\": \"${{ github.event_name }}\", \"inline\": true}
                ],
                \"footer\": {\"text\": \"Run ID: ${{ github.run_id }}\"}
              }]
            }" \
            $DISCORD_WEBHOOK_URL
