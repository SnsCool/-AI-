# X Trend Video Fetcher & Mimic Post Generator
# Daily automated workflow

name: Daily X Trend Agent

on:
  # Scheduled execution: Every day at 0:00 UTC (9:00 JST)
  schedule:
    - cron: '0 0 * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      test_x_posting:
        description: 'Test X posting (text only)'
        required: false
        type: boolean
        default: false
      use_commander:
        description: 'Use Commander Agent (AI-driven task routing)'
        required: false
        type: boolean
        default: false
      commander_request:
        description: 'Request to Commander Agent (if use_commander is true)'
        required: false
        type: string
        default: 'X投稿ワークフローを実行してください'

jobs:
  fetch-and-generate:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # Step 3: Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r x/requirements.txt

      # Step 4: Create service account key file from secret
      - name: Setup Google Cloud credentials
        run: |
          echo "${{ secrets.GCP_SA_KEY_JSON }}" > service_account.json
        env:
          GCP_SA_KEY_JSON: ${{ secrets.GCP_SA_KEY_JSON }}

      # Step 5a: Test X posting (API connection test only)
      - name: Test X Posting
        if: ${{ github.event.inputs.test_x_posting == 'true' }}
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}
        run: |
          cd x && python main.py --test-x

      # Step 5b: Commander mode (AI-driven task routing)
      - name: Run Commander Agent
        if: ${{ github.event.inputs.use_commander == 'true' && github.event.inputs.test_x_posting != 'true' }}
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
          GCP_SA_KEY_JSON: ${{ secrets.GCP_SA_KEY_JSON }}
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}
          ENABLE_X_POSTING: 'true'
        run: |
          cd x && python main.py --commander --request "${{ github.event.inputs.commander_request }}"

      # Step 5c: Full workflow (fetch → generate → post) - Fixed flow
      - name: Run X Trend Agent
        if: ${{ github.event.inputs.use_commander != 'true' && github.event.inputs.test_x_posting != 'true' }}
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
          GCP_SA_KEY_JSON: ${{ secrets.GCP_SA_KEY_JSON }}
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}
          ENABLE_X_POSTING: 'true'
        run: |
          cd x && python main.py --post-to-x

      # Step 6: Cleanup sensitive files
      - name: Cleanup
        if: always()
        run: |
          rm -f service_account.json
          echo "Cleanup completed"
