# Zoomå‹•ç”» Google Driveã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆè‡ªå‹•ï¼‰
# ã‚·ãƒ¼ãƒˆã®Zoomãƒªãƒ³ã‚¯ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€Driveã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãªã„å‹•ç”»ã‚’è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
name: Zoom Drive Upload

on:
  schedule:
    # æ¯æ™‚0åˆ†ã«å®Ÿè¡Œï¼ˆ1æ™‚é–“ãŠãï¼‰
    - cron: '0 * * * *'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

env:
  TZ: 'Asia/Tokyo'

jobs:
  upload:
    name: Upload Videos to Drive
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            zoom
            .github
          sparse-checkout-cone-mode: false

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('zoom/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r zoom/requirements.txt

      - name: Setup Google Credentials
        env:
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
        run: |
          umask 077
          if printf '%s' "$GOOGLE_CREDENTIALS_JSON" | base64 -d > /tmp/google_creds.json 2>/dev/null; then
            echo "Credentials decoded from base64."
          else
            printf '%s' "$GOOGLE_CREDENTIALS_JSON" > /tmp/google_creds.json
            echo "Credentials saved as raw JSON."
          fi
          chmod 600 /tmp/google_creds.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/google_creds.json" >> $GITHUB_ENV

      - name: Upload videos to Google Drive
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          GAS_WEBAPP_URL: ${{ secrets.GAS_WEBAPP_URL }}
          PYTHONUNBUFFERED: "1"
        run: |
          python zoom/batch_zoom.py --upload-videos-to-drive

      - name: Cleanup
        if: always()
        run: |
          rm -f /tmp/google_creds.json

  notify:
    name: Notify Results
    needs: upload
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          LOG_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          CURRENT_TIME=$(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')
          MENTION="<@1340666940615823451>"

          if [ "${{ needs.upload.result }}" == "success" ]; then
            TITLE="âœ… Drive Upload å®Œäº†"
            DESCRIPTION="Zoomå‹•ç”»ã®Driveã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸã€‚"
            COLOR=3066993
          elif [ "${{ needs.upload.result }}" == "failure" ]; then
            TITLE="âŒ Drive Upload ã‚¨ãƒ©ãƒ¼"
            DESCRIPTION="Driveã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ¬¡å›å®Ÿè¡Œã§è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ã•ã‚Œã¾ã™ã€‚"
            COLOR=15158332
          else
            TITLE="â­ï¸ Drive Upload ã‚¹ã‚­ãƒƒãƒ—"
            DESCRIPTION="ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
            COLOR=8421504
          fi

          curl -X POST -H 'Content-Type: application/json' \
            --data "{
              \"content\": \"${MENTION}\",
              \"embeds\": [{
                \"title\": \"${TITLE}\",
                \"description\": \"${DESCRIPTION}\\n\\n[ğŸ“‹ è©³ç´°ãƒ­ã‚°ã‚’ç¢ºèª](${LOG_URL})\",
                \"color\": ${COLOR},
                \"fields\": [
                  {\"name\": \"å®Ÿè¡Œæ™‚åˆ»\", \"value\": \"${CURRENT_TIME}\", \"inline\": true},
                  {\"name\": \"ãƒˆãƒªã‚¬ãƒ¼\", \"value\": \"${{ github.event_name }}\", \"inline\": true}
                ],
                \"footer\": {\"text\": \"Run ID: ${{ github.run_id }}\"}
              }]
            }" \
            $DISCORD_WEBHOOK_URL
