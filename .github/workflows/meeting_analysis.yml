# Zoom Meeting Analysis Agent
# Analyzes meeting transcripts and videos, generates feedback

name: Zoom Meeting Analysis

on:
  # 1時間ごとに自動実行
  schedule:
    - cron: '0 * * * *'

  # 手動実行
  workflow_dispatch:
    inputs:
      group:
        description: 'グループ番号 (1-6, 空=全アカウント)'
        required: false
        type: choice
        options:
          - ''
          - '1'
          - '2'
          - '3'
          - '4'
          - '5'
          - '6'
      dry_run:
        description: 'Dry run (書き込みなし)'
        required: false
        default: false
        type: boolean
      no_video:
        description: 'Skip video analysis (動画分析スキップ)'
        required: false
        default: false
        type: boolean
      run_test:
        description: 'Run test mode'
        required: false
        type: boolean
        default: false

  # Webhook trigger
  repository_dispatch:
    types: [analyze_meeting]

jobs:
  # バッチ処理（cron / 手動実行）
  batch-analyze:
    if: ${{ github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_test != 'true') }}
    runs-on: ubuntu-latest
    timeout-minutes: 60

    defaults:
      run:
        working-directory: zoom

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: zoom/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Calculate group number
        id: group
        run: |
          # 現在の時（0-23）からグループ番号（1-6）を計算
          # cron実行: 毎時0分 → 6グループでローテーション
          # 0時 → グループ1, 1時 → グループ2, ... 5時 → グループ6, 6時 → グループ1...
          HOUR=$(date +%H)
          GROUP=$(( HOUR % 6 + 1 ))
          echo "group=$GROUP" >> $GITHUB_OUTPUT
          echo "Processing group $GROUP/6 (hour: $HOUR)"

      - name: Run batch analysis
        env:
          # Supabase
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          # Gemini
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          # Google Sheets
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
          GOOGLE_SPREADSHEET_ID: ${{ secrets.GOOGLE_SPREADSHEET_ID }}
        run: |
          FLAGS=""
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            FLAGS="$FLAGS --dry-run"
          fi
          if [ "${{ github.event.inputs.no_video }}" = "true" ]; then
            FLAGS="$FLAGS --no-video"
          fi
          # グループ指定: cron実行時は自動計算、手動実行時はinputから
          if [ "${{ github.event_name }}" = "schedule" ]; then
            FLAGS="$FLAGS --group ${{ steps.group.outputs.group }}"
          elif [ -n "${{ github.event.inputs.group }}" ]; then
            FLAGS="$FLAGS --group ${{ github.event.inputs.group }}"
          fi
          python batch_zoom.py $FLAGS

      - name: Summary
        if: always()
        run: |
          echo "## Zoom Meeting Batch Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- Run ID: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- Triggered by: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

  # テストモード
  test:
    if: ${{ github.event.inputs.run_test == 'true' }}
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: zoom

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: zoom/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Test Mode
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python main.py --test

  # Webhook処理
  webhook-analyze:
    if: ${{ github.event_name == 'repository_dispatch' }}
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: zoom

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: zoom/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Analyze Transcript (Webhook)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TRANSCRIPT: ${{ github.event.client_payload.transcript }}
          ASSIGNEE: ${{ github.event.client_payload.assignee }}
          MEETING_DATE: ${{ github.event.client_payload.meeting_date }}
          CUSTOMER_NAME: ${{ github.event.client_payload.customer_name }}
        run: |
          echo "$TRANSCRIPT" > /tmp/transcript.txt
          python main.py \
            --file /tmp/transcript.txt \
            --assignee "$ASSIGNEE" \
            --date "$MEETING_DATE" \
            --customer "$CUSTOMER_NAME"
