# Zoom ãƒãƒƒãƒå‡¦ç†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# æ¯æ™‚å®Ÿè¡Œã¾ãŸã¯æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ã§ Zoom éŒ²ç”»ã‚’å‡¦ç†
name: Zoom Batch Processing

on:
  # æ¯æ™‚0åˆ†ã«å®Ÿè¡Œï¼ˆUTCï¼‰
  schedule:
    - cron: '0 * * * *'

  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      group:
        description: 'ã‚°ãƒ«ãƒ¼ãƒ—ç•ªå· (1-6ã€ç©ºæ¬„ã§å…¨ã‚°ãƒ«ãƒ¼ãƒ—é †æ¬¡å®Ÿè¡Œ)'
        required: false
        type: string
        default: ''
      from_date:
        description: 'é–‹å§‹æ—¥ (YYYY-MM-DD)'
        required: false
        type: string
        default: ''
      to_date:
        description: 'çµ‚äº†æ—¥ (YYYY-MM-DD)'
        required: false
        type: string
        default: ''
      limit:
        description: '1ã‚°ãƒ«ãƒ¼ãƒ—ã‚ãŸã‚Šã®å‡¦ç†ä»¶æ•°ä¸Šé™ï¼ˆ0 or ç©º = ç„¡åˆ¶é™ï¼‰'
        required: false
        type: number
        default: 0
      reprocess:
        description: 'å†å‡¦ç†ãƒ•ãƒ©ã‚°ï¼ˆå‡¦ç†æ¸ˆã¿ã‚‚å†å‡¦ç†ï¼‰'
        required: false
        type: boolean
        default: false

env:
  TZ: 'Asia/Tokyo'

jobs:
  # ãƒãƒˆãƒªã‚¯ã‚¹è¨­å®šã‚¸ãƒ§ãƒ–
  setup-matrix:
    name: Setup Matrix Strategy
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      should-run: ${{ steps.set-matrix.outputs.should-run }}
    steps:
      - id: set-matrix
        run: |
          if [ -z "${{ inputs.group }}" ]; then
            # groupãŒç©ºæ¬„ã®å ´åˆï¼šå…¨ã‚°ãƒ«ãƒ¼ãƒ—(1-6)ã‚’é †æ¬¡å®Ÿè¡Œ
            echo "matrix={\"group\":[1,2,3,4,5,6]}" >> $GITHUB_OUTPUT
            echo "should-run=true" >> $GITHUB_OUTPUT
            echo "Run mode: All groups"
          else
            # groupãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆï¼šæŒ‡å®šã‚°ãƒ«ãƒ¼ãƒ—ã®ã¿ã‚’å®Ÿè¡Œ
            if [[ "${{ inputs.group }}" =~ ^[1-6]$ ]]; then
              echo "matrix={\"group\":[${{ inputs.group }}]}" >> $GITHUB_OUTPUT
              echo "should-run=true" >> $GITHUB_OUTPUT
              echo "Run mode: Group ${{ inputs.group }}"
            else
              echo "Error: Invalid group number '${{ inputs.group }}'. Must be 1-6."
              echo "should-run=false" >> $GITHUB_OUTPUT
            fi
          fi

  # ãƒ¡ã‚¤ãƒ³å‡¦ç†ã‚¸ãƒ§ãƒ–
  process:
    name: Process Group ${{ matrix.group }}
    needs: setup-matrix
    if: needs.setup-matrix.outputs.should-run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30  # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ30åˆ†ï¼‰
    strategy:
      matrix: ${{ fromJson(needs.setup-matrix.outputs.matrix) }}
      fail-fast: false  # ã‚ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ãŒå¤±æ•—ã—ã¦ã‚‚ä»–ã®ã‚°ãƒ«ãƒ¼ãƒ—ã¯ç¶™ç¶š
      max-parallel: 1   # é †æ¬¡å®Ÿè¡Œï¼ˆAPIåˆ¶é™å¯¾ç­–ï¼‰
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            zoom
            .github
          sparse-checkout-cone-mode: false

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('zoom/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r zoom/requirements.txt

      - name: Setup Google Credentials
        env:
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
        run: |
          # ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆbase64ã¾ãŸã¯raw JSONã«å¯¾å¿œï¼‰
          umask 077
          # ã¾ãšbase64ãƒ‡ã‚³ãƒ¼ãƒ‰ã‚’è©¦è¡Œã€å¤±æ•—ã—ãŸã‚‰raw JSONã¨ã—ã¦æ‰±ã†
          if printf '%s' "$GOOGLE_CREDENTIALS_JSON" | base64 -d > /tmp/google_creds.json 2>/dev/null; then
            echo "Credentials decoded from base64."
          else
            printf '%s' "$GOOGLE_CREDENTIALS_JSON" > /tmp/google_creds.json
            echo "Credentials saved as raw JSON."
          fi
          chmod 600 /tmp/google_creds.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/google_creds.json" >> $GITHUB_ENV
          echo "Google credentials file created with secure permissions."

      - name: Validate Inputs
        id: validate
        run: |
          # æ—¥ä»˜å½¢å¼ã®æ¤œè¨¼ (YYYY-MM-DD)
          DATE_REGEX='^[0-9]{4}-[0-9]{2}-[0-9]{2}$'

          FROM_DATE="${{ inputs.from_date }}"
          TO_DATE="${{ inputs.to_date }}"

          if [ -n "$FROM_DATE" ] && ! [[ "$FROM_DATE" =~ $DATE_REGEX ]]; then
            echo "Error: Invalid from_date format. Expected YYYY-MM-DD, got: $FROM_DATE"
            exit 1
          fi

          if [ -n "$TO_DATE" ] && ! [[ "$TO_DATE" =~ $DATE_REGEX ]]; then
            echo "Error: Invalid to_date format. Expected YYYY-MM-DD, got: $TO_DATE"
            exit 1
          fi

          echo "Input validation passed."

      - name: Run Batch Script (Group ${{ matrix.group }})
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          ZAI_API_KEY: ${{ secrets.ZAI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
          PYTHONUNBUFFERED: "1"  # ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°å‡ºåŠ›
        run: |
          # é…åˆ—ã§ã‚³ãƒãƒ³ãƒ‰ã‚’æ§‹ç¯‰ï¼ˆå®‰å…¨ãªå¼•æ•°å‡¦ç†ï¼‰
          CMD=(python zoom/batch_zoom.py --group "${{ matrix.group }}")

          # å‡¦ç†ä»¶æ•°åˆ¶é™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ç„¡åˆ¶é™ï¼‰
          LIMIT="${{ inputs.limit }}"
          if [ -n "$LIMIT" ] && [ "$LIMIT" -gt 0 ] 2>/dev/null; then
            CMD+=(--limit "$LIMIT")
          fi

          # æ—¥ä»˜ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ
          if [ -n "${{ inputs.from_date }}" ]; then
            CMD+=(--from-date "${{ inputs.from_date }}")
          fi
          if [ -n "${{ inputs.to_date }}" ]; then
            CMD+=(--to-date "${{ inputs.to_date }}")
          fi

          # å†å‡¦ç†ãƒ•ãƒ©ã‚°
          if [ "${{ inputs.reprocess }}" == "true" ]; then
            CMD+=(--reprocess)
          fi

          echo "Running: ${CMD[*]}"
          echo "ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: 30åˆ†ã€å‡¦ç†ä¸Šé™: ${LIMIT}ä»¶/ã‚°ãƒ«ãƒ¼ãƒ—"
          "${CMD[@]}"

      - name: Cleanup
        if: always()
        run: |
          rm -f /tmp/google_creds.json

  # é€šçŸ¥ã‚¸ãƒ§ãƒ–
  notify:
    name: Notify Results
    needs: [setup-matrix, process]
    if: always() && needs.setup-matrix.outputs.should-run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Determine Job Status
        id: status
        run: |
          if [ "${{ needs.process.result }}" != "success" ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "Some jobs failed."
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "All jobs succeeded."
          fi

      - name: Get Error Details
        id: error-details
        if: needs.process.result != 'success'
        run: |
          # GitHub CLIã§ã‚¸ãƒ§ãƒ–æƒ…å ±ã‚’å–å¾—
          FAILED_JOBS=$(gh run view ${{ github.run_id }} --json jobs --jq '.jobs[] | select(.conclusion == "failure") | .name' 2>/dev/null | tr '\n' ', ' | sed 's/,$//')
          if [ -z "$FAILED_JOBS" ]; then
            FAILED_JOBS="ä¸æ˜"
          fi
          echo "failed_jobs=$FAILED_JOBS" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Send Slack Notification on Failure
        if: steps.status.outputs.status == 'failure' && env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"âš ï¸ Zoom Batch Workflow Failed\\nRepository: ${{ github.repository }}\\nRun: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" \
            $SLACK_WEBHOOK_URL

      - name: Send Discord Notification
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          LOG_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          CURRENT_TIME=$(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')

          if [ "${{ steps.status.outputs.status }}" == "failure" ]; then
            FAILED_JOBS="${{ steps.error-details.outputs.failed_jobs }}"
            TITLE="âŒ Zoom Batch å‡¦ç†ã‚¨ãƒ©ãƒ¼"
            DESCRIPTION="ä¸€éƒ¨ã®ã‚°ãƒ«ãƒ¼ãƒ—å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\\n\\n**å¤±æ•—ã—ãŸã‚¸ãƒ§ãƒ–:** ${FAILED_JOBS}"
            COLOR=15158332
            STATUS_ICON="âŒ"
          else
            TITLE="âœ… Zoom Batch å‡¦ç†å®Œäº†"
            DESCRIPTION="ã™ã¹ã¦ã®ã‚°ãƒ«ãƒ¼ãƒ—å‡¦ç†ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚"
            COLOR=3066993
            STATUS_ICON="âœ…"
          fi

          # å¸¸ã«ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³
          MENTION="<@1340666940615823451>"

          curl -X POST -H 'Content-Type: application/json' \
            --data "{
              \"content\": \"${MENTION}\",
              \"embeds\": [{
                \"title\": \"${TITLE}\",
                \"description\": \"${DESCRIPTION}\\n\\n[ğŸ“‹ è©³ç´°ãƒ­ã‚°ã‚’ç¢ºèª](${LOG_URL})\",
                \"color\": ${COLOR},
                \"fields\": [
                  {\"name\": \"ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹\", \"value\": \"${STATUS_ICON} ${{ steps.status.outputs.status }}\", \"inline\": true},
                  {\"name\": \"å®Ÿè¡Œæ™‚åˆ»\", \"value\": \"${CURRENT_TIME}\", \"inline\": true},
                  {\"name\": \"ãƒˆãƒªã‚¬ãƒ¼\", \"value\": \"${{ github.event_name }}\", \"inline\": true}
                ],
                \"footer\": {\"text\": \"Run ID: ${{ github.run_id }}\"}
              }]
            }" \
            $DISCORD_WEBHOOK_URL

      - name: Output Summary
        if: always()
        run: |
          echo "## Zoom Batch Processing Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.status.outputs.status }}" == "failure" ]; then
            echo "âŒ **ä¸€éƒ¨ã®ã‚°ãƒ«ãƒ¼ãƒ—å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **ã™ã¹ã¦ã®ã‚°ãƒ«ãƒ¼ãƒ—å‡¦ç†ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- å®Ÿè¡Œæ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "- [è©³ç´°ãƒ­ã‚°ã‚’ç¢ºèª](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
