# Zoom çµ±åˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# ãƒãƒƒãƒå‡¦ç†ãƒ»å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ»Webhookåˆ†æãƒ»ãƒ†ã‚¹ãƒˆã‚’çµ±åˆ
name: Zoom Batch Processing

on:
  # 10åˆ†ã”ã¨ã«å®Ÿè¡Œï¼ˆã‚°ãƒ«ãƒ¼ãƒ—å˜ä½ã§åˆ†æ•£å‡¦ç†ï¼‰
  schedule:
    - cron: '*/10 * * * *'

  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      group:
        description: 'ã‚°ãƒ«ãƒ¼ãƒ—ç•ªå· (1-6ã€ç©ºæ¬„ã§å…¨ã‚°ãƒ«ãƒ¼ãƒ—é †æ¬¡å®Ÿè¡Œ)'
        required: false
        type: string
        default: ''
      from_date:
        description: 'é–‹å§‹æ—¥ (YYYY-MM-DD)'
        required: false
        type: string
        default: ''
      to_date:
        description: 'çµ‚äº†æ—¥ (YYYY-MM-DD)'
        required: false
        type: string
        default: ''
      limit:
        description: '1ã‚°ãƒ«ãƒ¼ãƒ—ã‚ãŸã‚Šã®å‡¦ç†ä»¶æ•°ä¸Šé™ï¼ˆ0 or ç©º = ç„¡åˆ¶é™ï¼‰'
        required: false
        type: number
        default: 0
      reprocess:
        description: 'å†å‡¦ç†ãƒ•ãƒ©ã‚°ï¼ˆå‡¦ç†æ¸ˆã¿ã‚‚å†å‡¦ç†ï¼‰'
        required: false
        type: boolean
        default: false
      dry_run:
        description: 'Dry runï¼ˆæ›¸ãè¾¼ã¿ãªã—ï¼‰'
        required: false
        type: boolean
        default: false
      no_video:
        description: 'å‹•ç”»å‡¦ç†ã‚¹ã‚­ãƒƒãƒ—ï¼ˆ--fastï¼‰'
        required: false
        type: boolean
        default: false
      run_test:
        description: 'ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰å®Ÿè¡Œ'
        required: false
        type: boolean
        default: false
      upload_videos:
        description: 'å‹•ç”»Driveã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ'
        required: false
        type: boolean
        default: false

  # Webhookï¼ˆå¤–éƒ¨ã‹ã‚‰ã®åˆ†æãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰
  repository_dispatch:
    types: [analyze_meeting]

env:
  TZ: 'Asia/Tokyo'

jobs:
  # ãƒãƒˆãƒªã‚¯ã‚¹è¨­å®šã‚¸ãƒ§ãƒ–
  setup-matrix:
    name: Setup Matrix Strategy
    if: ${{ github.event_name != 'repository_dispatch' && inputs.run_test != true }}
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      should-run: ${{ steps.set-matrix.outputs.should-run }}
    steps:
      - id: set-matrix
        run: |
          if [ "${{ github.event_name }}" == "schedule" ]; then
            # cronå®Ÿè¡Œ: ç¾åœ¨ã®åˆ†ã‹ã‚‰ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è‡ªå‹•è¨ˆç®—
            # 0åˆ†â†’G1, 10åˆ†â†’G2, 20åˆ†â†’G3, 30åˆ†â†’G4, 40åˆ†â†’G5, 50åˆ†â†’G6
            MINUTE=$(TZ=Asia/Tokyo date +%M)
            GROUP=$(( MINUTE / 10 + 1 ))
            echo "matrix={\"group\":[${GROUP}]}" >> $GITHUB_OUTPUT
            echo "should-run=true" >> $GITHUB_OUTPUT
            echo "Schedule mode: Group ${GROUP}/6 (minute: ${MINUTE})"
          elif [ -z "${{ inputs.group }}" ]; then
            # æ‰‹å‹•å®Ÿè¡Œï¼ˆgroupæœªæŒ‡å®šï¼‰: å…¨ã‚°ãƒ«ãƒ¼ãƒ—é †æ¬¡å®Ÿè¡Œ
            echo "matrix={\"group\":[1,2,3,4,5,6]}" >> $GITHUB_OUTPUT
            echo "should-run=true" >> $GITHUB_OUTPUT
            echo "Manual mode: All groups"
          else
            # æ‰‹å‹•å®Ÿè¡Œï¼ˆgroupæŒ‡å®šï¼‰: æŒ‡å®šã‚°ãƒ«ãƒ¼ãƒ—ã®ã¿
            if [[ "${{ inputs.group }}" =~ ^[1-6]$ ]]; then
              echo "matrix={\"group\":[${{ inputs.group }}]}" >> $GITHUB_OUTPUT
              echo "should-run=true" >> $GITHUB_OUTPUT
              echo "Manual mode: Group ${{ inputs.group }}"
            else
              echo "Error: Invalid group number '${{ inputs.group }}'. Must be 1-6."
              echo "should-run=false" >> $GITHUB_OUTPUT
            fi
          fi

  # ãƒ¡ã‚¤ãƒ³å‡¦ç†ã‚¸ãƒ§ãƒ–
  process:
    name: Process Group ${{ matrix.group }}
    needs: setup-matrix
    if: needs.setup-matrix.outputs.should-run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix: ${{ fromJson(needs.setup-matrix.outputs.matrix) }}
      fail-fast: false
      max-parallel: 1
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            zoom
            .github
          sparse-checkout-cone-mode: false

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('zoom/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r zoom/requirements.txt

      - name: Setup Google Credentials
        env:
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
        run: |
          umask 077
          if printf '%s' "$GOOGLE_CREDENTIALS_JSON" | base64 -d > /tmp/google_creds.json 2>/dev/null; then
            echo "Credentials decoded from base64."
          else
            printf '%s' "$GOOGLE_CREDENTIALS_JSON" > /tmp/google_creds.json
            echo "Credentials saved as raw JSON."
          fi
          chmod 600 /tmp/google_creds.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/google_creds.json" >> $GITHUB_ENV

      - name: Validate Inputs
        id: validate
        run: |
          DATE_REGEX='^[0-9]{4}-[0-9]{2}-[0-9]{2}$'
          FROM_DATE="${{ inputs.from_date }}"
          TO_DATE="${{ inputs.to_date }}"
          if [ -n "$FROM_DATE" ] && ! [[ "$FROM_DATE" =~ $DATE_REGEX ]]; then
            echo "Error: Invalid from_date format. Expected YYYY-MM-DD, got: $FROM_DATE"
            exit 1
          fi
          if [ -n "$TO_DATE" ] && ! [[ "$TO_DATE" =~ $DATE_REGEX ]]; then
            echo "Error: Invalid to_date format. Expected YYYY-MM-DD, got: $TO_DATE"
            exit 1
          fi
          echo "Input validation passed."

      - name: Run Batch Script (Group ${{ matrix.group }})
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          ZAI_API_KEY: ${{ secrets.ZAI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
          GOOGLE_SPREADSHEET_ID: ${{ secrets.GOOGLE_SPREADSHEET_ID }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GAS_WEBAPP_URL: ${{ secrets.GAS_WEBAPP_URL }}
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          PYTHONUNBUFFERED: "1"
        run: |
          CMD=(python zoom/batch_zoom.py --group "${{ matrix.group }}")

          LIMIT="${{ inputs.limit }}"
          if [ -n "$LIMIT" ] && [ "$LIMIT" -gt 0 ] 2>/dev/null; then
            CMD+=(--limit "$LIMIT")
          fi

          if [ -n "${{ inputs.from_date }}" ]; then
            CMD+=(--from-date "${{ inputs.from_date }}")
          fi
          if [ -n "${{ inputs.to_date }}" ]; then
            CMD+=(--to-date "${{ inputs.to_date }}")
          fi

          if [ "${{ inputs.reprocess }}" == "true" ]; then
            CMD+=(--reprocess)
          fi
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            CMD+=(--dry-run)
          fi
          if [ "${{ inputs.no_video }}" == "true" ]; then
            CMD+=(--fast)
          fi

          echo "Running: ${CMD[*]}"
          "${CMD[@]}"

      - name: Cleanup
        if: always()
        run: |
          rm -f /tmp/google_creds.json

  # å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¸ãƒ§ãƒ–ï¼ˆæ¯æ™‚0åˆ† = G1ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®ã¿è‡ªå‹•å®Ÿè¡Œï¼‰
  upload-videos:
    name: Upload Videos to Drive
    if: ${{ (github.event_name == 'workflow_dispatch' && inputs.upload_videos == true) }}
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            zoom
            .github
          sparse-checkout-cone-mode: false

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('zoom/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r zoom/requirements.txt

      - name: Setup Google Credentials
        env:
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
        run: |
          umask 077
          if printf '%s' "$GOOGLE_CREDENTIALS_JSON" | base64 -d > /tmp/google_creds.json 2>/dev/null; then
            echo "Credentials decoded from base64."
          else
            printf '%s' "$GOOGLE_CREDENTIALS_JSON" > /tmp/google_creds.json
            echo "Credentials saved as raw JSON."
          fi
          chmod 600 /tmp/google_creds.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/google_creds.json" >> $GITHUB_ENV

      - name: Upload videos to Google Drive
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          GAS_WEBAPP_URL: ${{ secrets.GAS_WEBAPP_URL }}
          PYTHONUNBUFFERED: "1"
        run: |
          python zoom/batch_zoom.py --upload-videos-to-drive

      - name: Cleanup
        if: always()
        run: |
          rm -f /tmp/google_creds.json

  # Webhookåˆ†æã‚¸ãƒ§ãƒ–
  webhook-analyze:
    name: Analyze Meeting (Webhook)
    if: ${{ github.event_name == 'repository_dispatch' }}
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            zoom
            .github
          sparse-checkout-cone-mode: false

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('zoom/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r zoom/requirements.txt

      - name: Analyze Transcript
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TRANSCRIPT: ${{ github.event.client_payload.transcript }}
          ASSIGNEE: ${{ github.event.client_payload.assignee }}
          MEETING_DATE: ${{ github.event.client_payload.meeting_date }}
          CUSTOMER_NAME: ${{ github.event.client_payload.customer_name }}
          PYTHONUNBUFFERED: "1"
        run: |
          echo "$TRANSCRIPT" > /tmp/transcript.txt
          python zoom/main.py \
            --file /tmp/transcript.txt \
            --assignee "$ASSIGNEE" \
            --date "$MEETING_DATE" \
            --customer "$CUSTOMER_NAME"

  # ãƒ†ã‚¹ãƒˆã‚¸ãƒ§ãƒ–
  test:
    name: Run Test Mode
    if: ${{ inputs.run_test == true }}
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            zoom
            .github
          sparse-checkout-cone-mode: false

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('zoom/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r zoom/requirements.txt

      - name: Run Test Mode
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PYTHONUNBUFFERED: "1"
        run: |
          python zoom/main.py --test

  # é€šçŸ¥ã‚¸ãƒ§ãƒ–
  notify:
    name: Notify Results
    needs: [setup-matrix, process, upload-videos, webhook-analyze, test]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Determine Job Status
        id: status
        run: |
          # å„ã‚¸ãƒ§ãƒ–ã®çµæœã‚’åé›†ï¼ˆskippedã¯ç„¡è¦–ï¼‰
          FAILED=""
          SUCCEEDED=""

          for JOB_NAME in process upload-videos webhook-analyze test; do
            RESULT=""
            case "$JOB_NAME" in
              process)         RESULT="${{ needs.process.result }}" ;;
              upload-videos)   RESULT="${{ needs.upload-videos.result }}" ;;
              webhook-analyze) RESULT="${{ needs.webhook-analyze.result }}" ;;
              test)            RESULT="${{ needs.test.result }}" ;;
            esac

            if [ "$RESULT" == "failure" ]; then
              FAILED="${FAILED}${JOB_NAME}, "
            elif [ "$RESULT" == "success" ]; then
              SUCCEEDED="${SUCCEEDED}${JOB_NAME}, "
            fi
          done

          if [ -n "$FAILED" ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "failed_jobs=${FAILED%, }" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "failed_jobs=" >> $GITHUB_OUTPUT
          fi
          echo "succeeded_jobs=${SUCCEEDED%, }" >> $GITHUB_OUTPUT

      - name: Send Slack Notification on Failure
        if: steps.status.outputs.status == 'failure' && env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"âš ï¸ Zoom Batch Workflow Failed\\nFailed: ${{ steps.status.outputs.failed_jobs }}\\nRun: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" \
            $SLACK_WEBHOOK_URL

      - name: Send Discord Notification
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          LOG_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          CURRENT_TIME=$(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')

          if [ "${{ steps.status.outputs.status }}" == "failure" ]; then
            FAILED_JOBS="${{ steps.status.outputs.failed_jobs }}"
            TITLE="âŒ Zoom å‡¦ç†ã‚¨ãƒ©ãƒ¼"
            DESCRIPTION="ä¸€éƒ¨ã®å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\\n\\n**å¤±æ•—:** ${FAILED_JOBS}"
            COLOR=15158332
            STATUS_ICON="âŒ"
          else
            TITLE="âœ… Zoom å‡¦ç†å®Œäº†"
            DESCRIPTION="ã™ã¹ã¦ã®å‡¦ç†ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚"
            COLOR=3066993
            STATUS_ICON="âœ…"
          fi

          MENTION="<@1340666940615823451>"

          curl -X POST -H 'Content-Type: application/json' \
            --data "{
              \"content\": \"${MENTION}\",
              \"embeds\": [{
                \"title\": \"${TITLE}\",
                \"description\": \"${DESCRIPTION}\\n\\n[ğŸ“‹ è©³ç´°ãƒ­ã‚°ã‚’ç¢ºèª](${LOG_URL})\",
                \"color\": ${COLOR},
                \"fields\": [
                  {\"name\": \"ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹\", \"value\": \"${STATUS_ICON} ${{ steps.status.outputs.status }}\", \"inline\": true},
                  {\"name\": \"å®Ÿè¡Œæ™‚åˆ»\", \"value\": \"${CURRENT_TIME}\", \"inline\": true},
                  {\"name\": \"ãƒˆãƒªã‚¬ãƒ¼\", \"value\": \"${{ github.event_name }}\", \"inline\": true}
                ],
                \"footer\": {\"text\": \"Run ID: ${{ github.run_id }}\"}
              }]
            }" \
            $DISCORD_WEBHOOK_URL

      - name: Output Summary
        if: always()
        run: |
          echo "## Zoom Processing Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.status.outputs.status }}" == "failure" ]; then
            echo "âŒ **ä¸€éƒ¨ã®å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ**" >> $GITHUB_STEP_SUMMARY
            echo "- å¤±æ•—: ${{ steps.status.outputs.failed_jobs }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **ã™ã¹ã¦ã®å‡¦ç†ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- å®Ÿè¡Œæ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "- ãƒˆãƒªã‚¬ãƒ¼: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- [è©³ç´°ãƒ­ã‚°ã‚’ç¢ºèª](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
