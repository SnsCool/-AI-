# Sales Feedback Agent - RAGFlow Docker Compose
# 営業フィードバックエージェント用 RAGFlow構成

version: '3.8'

services:
  # ===========================================
  # RAGFlow メインサービス
  # ===========================================
  ragflow:
    image: infiniflow/ragflow:v0.14.1-slim
    container_name: sales-feedback-ragflow
    ports:
      - "${RAGFLOW_PORT:-8080}:80"      # Web UI & API
      - "${RAGFLOW_API_PORT:-9380}:9380" # API専用ポート
    volumes:
      - ragflow_data:/ragflow/data
      - ragflow_logs:/ragflow/logs
      - ./uploads:/ragflow/uploads      # アップロードファイル
    environment:
      - TZ=Asia/Tokyo
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_USER=root
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-ragflow123}
      - MYSQL_DATABASE=ragflow
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - MINIO_HOST=minio
      - MINIO_PORT=9000
      - MINIO_USER=${MINIO_USER:-minioadmin}
      - MINIO_PASSWORD=${MINIO_PASSWORD:-minioadmin}
      - ES_HOST=elasticsearch
      - ES_PORT=9200
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_started
      minio:
        condition: service_started
      elasticsearch:
        condition: service_healthy
    networks:
      - sales-feedback-net
    restart: unless-stopped

  # ===========================================
  # MySQL - メタデータストレージ
  # ===========================================
  mysql:
    image: mysql:8.0
    container_name: sales-feedback-mysql
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_PASSWORD:-ragflow123}
      - MYSQL_DATABASE=ragflow
      - TZ=Asia/Tokyo
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - sales-feedback-net
    restart: unless-stopped

  # ===========================================
  # Redis - キャッシュ・セッション
  # ===========================================
  redis:
    image: redis:7-alpine
    container_name: sales-feedback-redis
    volumes:
      - redis_data:/data
    networks:
      - sales-feedback-net
    restart: unless-stopped

  # ===========================================
  # MinIO - ファイルストレージ
  # ===========================================
  minio:
    image: minio/minio:latest
    container_name: sales-feedback-minio
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_PASSWORD:-minioadmin}
    volumes:
      - minio_data:/data
    ports:
      - "${MINIO_CONSOLE_PORT:-9001}:9001"  # MinIO Console
    networks:
      - sales-feedback-net
    restart: unless-stopped

  # ===========================================
  # Elasticsearch - 全文検索エンジン
  # ===========================================
  elasticsearch:
    image: elasticsearch:8.11.3
    container_name: sales-feedback-es
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - TZ=Asia/Tokyo
    volumes:
      - es_data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200/_cluster/health | grep -q 'green\\|yellow'"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - sales-feedback-net
    restart: unless-stopped

# ===========================================
# ボリューム定義
# ===========================================
volumes:
  ragflow_data:
    name: sales-feedback-ragflow-data
  ragflow_logs:
    name: sales-feedback-ragflow-logs
  mysql_data:
    name: sales-feedback-mysql-data
  redis_data:
    name: sales-feedback-redis-data
  minio_data:
    name: sales-feedback-minio-data
  es_data:
    name: sales-feedback-es-data

# ===========================================
# ネットワーク定義
# ===========================================
networks:
  sales-feedback-net:
    name: sales-feedback-network
    driver: bridge
