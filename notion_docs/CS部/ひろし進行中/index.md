# ひろし進行中

**種類**: 📄 ページ
**階層**: 2
**更新日時**: 2026-01-14 12:09

---

## コンテンツ

## 生徒管理シート：現状と今後の方針相談
### 要約
- **現状の問題**
1. フォーム追記とGAS更新が同一シートで競合し、**欠損/ズレが再発しうる**
1. データ重複・手動追記が混在しており、**1ユーザー=1行が崩れている（検証不能）**
1. 取得不可が「理由なし」で残り、**改善アクションに繋がらない**
1. 監視がなく、**事故が起きても当日気づけない**
- **短期の結論案**
1. 入力と更新を**分離（フォーム連携専用→運用・更新用）**
1. 既存データを**整流して初期状態を作る（トリガー停止して実施）**
1. 取得不可は**原因カテゴリ+最終失敗日時**だけ残す
1. 当日分の空欄は**全件走査後に1回だけ再取得**
1. 取得率が一定以下なら**アラート**
- **中期の提案**
DB化は段階1として**「履歴・監視」だけ**を先に持ち、再発を当日検知できる状態を作る
- **決めたいYes/No**
<details>
<summary>短期：フォーム連携専用シート/運用・更新用シート分離をやる</summary>
- 効果：競合による欠損を構造的に潰す（再発確率を大幅に下げる）
- コスト：シート増＋同期ロジック追加（中）
<details>
<summary>短期：整流のためにトリガーを止める</summary>
- 効果：検証可能な初期状態を作れる
- リスク：停止中は当日データが埋まらない
<details>
<summary>短期：取得不可のログを取得する</summary>
- 最小：カテゴリ + last_error_at + http_code
- 判断基準：運用が「原因別に対処できる」ことがゴール
<details>
<summary>短期：当日空欄の単発再取得を入れる</summary>
- 効果：一時失敗（RateLimit等）の取りこぼし回収
- リスク：API負荷増（上限管理が必要）
<details>
<summary>中期：DB段階1（履歴・監視）を並行着手する</summary>
- 効果：事故を当日検知できる（監視を先に得る）
- コスト：DB基盤/設計/ETL（小〜中、選ぶDBで変動）
<details>
<summary>運用：画像は消してリンクだけにする</summary>
- 効果：シート軽量化・計算/描画負荷低下
- 代替：リンクのみ or 表示用ビューに隔離
### 詳細
### 現状の仕組み
- 生徒情報は **Googleフォーム → 生徒管理シート（集計用）** に連携される
<details>
<summary>GAS（15分トリガー）が `all_sheet_delete` を実行し、Instagram Graph API（business_discovery）から以下を取得してシートへ反映</summary>
- **フォロワー数**（日付列に記録）
- **最新投稿日時**（昨日投稿ならセル背景を緑、違えば赤）
- （成功時）プロフィール画像（D列に `HYPERLINK + IMAGE`）
- （失敗時）D列に **「取得不可」** を書く
<details>
<summary>15分更新処理：日次取得を「200件ずつ分割して埋める」（リアルタイム更新ではない）</summary>
- MAX_USERS_PER_RUN=200
- 当日列が空の行だけ対象にして埋める（埋まった人はその日はスキップ）
- PropertiesService で **途中再開（処理済み行）** を持つ
- 変更申請は **別フォーム → 変更申請シート** に入り、現状は状況により **手作業で集計用へ反映**している（フォーム未提出の変更申請があるため）
### 現状データ
- 重複：**約9%**（同一usernameが複数行 → 更新漏れ/取得不可の原因になりうる）
- 取得不可：**約17%**（理由が残らず、運用で切り分け不能）
- フォーム vs 集計用に**説明不能な差分**あり（反映漏れ/消失が起きうる前提で対策が必要）
<details>
<summary>詳細データ</summary>
<details>
<summary>提出フォーム（Googleフォーム）</summary>
- 申請件数：**2,378**
- usernameユニーク：**2,141**
- 重複：**236（約9.9%）**
- 直近30日：**260 / ユニーク240**
<details>
<summary>生徒管理シート（集計用CSV）</summary>
- 行数：**2,085**
- username入力あり：**2,083**
- usernameユニーク：**1,902**
- 重複行：**181（約9%）**（同一usernameが複数行）
<details>
<summary>取得不可：**348行 / 330ユニーク（約17.3%）**</summary>
※フォーム（2,378件）と集計用（2,085行）に差分があり、重複等を除いても説明できない部分があるため「反映漏れ/消失が起きうる前提」で短期対策を進めたい
### （2025/12/21〜12/30 の10日欠損について）
- この期間の欠損は、たいちさんにて、**2025/12/31 に修正済み**
- ただし、「同様の不具合が再発しても気づけない」状態だと同じ事故が繰り返されるため、**監視/ヘルスチェックだけは短期で入れる価値がある**（後述）
### 懸念点
<details>
<summary>①フォーム連携とGAS実行が重なると、欠損/事故が起きる可能性</summary>
- **同じシート**で「フォーム追記（外部）」「データ読み書き・列挿入（GAS）」を同時にやっているため、衝突する可能性がある
- 「消えた／反映されない／ズレた」に見える事故が起きうる
→ **入力（フォーム）と更新（GAS）の責務分離**が必要
<details>
<summary>②重複が構造的に取得不可・空欄を自分で作っている</summary>
- コードは `rowByUsername[username] = row` で **usernameごとに1行しか保持しない**
- 同一usernameが複数行あると、**最終行だけ更新され、それ以前の行は更新されない**
→ ユーザーから見ると「なぜか取れてない行がある」の一因になる（取得不可に見える/空欄が残る）
<details>
<summary>③取得不可の理由が残らず、永遠に解消できない</summary>
- 現在は「取得不可」とだけ書かれる
- 実際には HTTPコードやGraph APIのエラー本文を持っているのに、**運用側が見えない**
→ 解消導線が作れない
<details>
<summary>④行ズレの温床：フォーム未提出の変更申請を手作業で追記している</summary>
- 「フォームに入力していないのに変更申請」があり、対象がいない場合に手作業で追記している
- この手作業が、フォーム連携の追記と混ざることで **行位置依存の事故**を誘発する
<details>
<summary>（⑤日次データの取得時刻がばらつく問題）</summary>
- これは仕様として割り切り（大量連続取得をAPI側が許さないため）、**定義は今は詰めない**
- ばらつきは避けられない前提で、「欠損を作らない」「原因が追える」を優先する
### 対策案（短期）
<details>
<summary>①入力と更新を分離</summary>
**目的**：フォーム連携とGAS実行の競合（「フォーム追記中にGASが列挿入・書き込みして壊れる」系の事故）で欠損が起きるリスクを潰す
- **フォーム連携専用シート**：フォームからの追記だけを受ける。GASは基本触らない（読み取りのみ）
- **運用・更新用シート**：GASが更新するのはここだけ（人間は触らない）
- 1ユーザー=1行（usernameをキーに正規化）
- 重複時は **最新timestampを採用**（ルールを固定）
- **変更申請シート**：変更申請フォームからの追記＋人間の手入力を受ける。
- **フォーム連携専用シート＋変更申請シート ⇒運用・更新用シート** で統合する
- フォーム未提出でも変更申請が来るケースは、**例外的に運用・更新用シートへ作成**
- ただし、作成元が変更申請のものは後から追えるように区別
※ここでの分離の主目的は「行ズレ」よりも、**フォーム追記とGAS更新が同時に走ることによる事故リスクの排除**。
<details>
<summary>②データ整流（現状データを“正”に戻す）</summary>
**目的**：重複・手動追記・ズレのある状態でロジックを直しても検証不能なので、まず“正しい初期状態”を作る。
<details>
<summary>①15分処理（all_sheet_delete）を一時停止</summary>
フォーム追記や人手作業と競合しない状態で整流するため
<details>
<summary>②整流方針を固定</summary>
フォーム連携専用シートは全件保持、運用・更新用シートは最新1件を採用
1. username（正規化後）を主キーとして統一
1. 重複時の正：**timestampが最新の提出を採用**（フォーム履歴は残す）
1. 手動追記：フォーム未提出の変更申請は、運用・更新用シートへキー更新で反映
<details>
<summary>③整流の実施（人力でも可。ただし結果は再現可能に）</summary>
1. 重複行の集約（採用行を1つに決め、他はアーカイブ/削除/別シート移動）
1. 「取得不可」行は原因カテゴリに振り分け（最低限）
1. 運用・更新用シートを“1ユーザー1行”に戻す
<details>
<summary>④再開条件</summary>
1. フォーム連携専用シート/運用・更新用シート分離が完了してからトリガーを再開
1. 再開後、初日だけ取得率のヘルスチェックを強める（再発早期検知）
<details>
<summary>③取得不可の可視化（“原因カテゴリ”だけでいい）</summary>
**目的**：「取得不可」を放置しない。運用で直せるものは直す。
<details>
<summary>取得不可の代表原因（現状想定）</summary>
1. 重複行があるため、最終行のみ更新され、それ以前が取得不可/空欄扱いになる
1. 対象がビジネス/クリエイターでない
1. usernameが存在しない（退会/凍結）・変更された・入力ミス
1. ブロック等で取得不能
1. 一時的失敗（Rate Limit 等）
<details>
<summary>最低限追加したい内容</summary>
- `last_error_at`（最終失敗日時）
- `error_type`（エラーコードor上の4分類）
- `error_detail`（短いエラーメッセージ）※最大文字数は要検討
<details>
<summary>④「全件取得が終わったのに空のもの」だけ、**もう1回だけ**再取得</summary>
**目的**：データ精度向上のため、当日分の一時的失敗（Rate Limit等）による取りこぼしだけ拾う。
- 当日列について、全件走査完了（targets=0）後に
- **当日列が空欄のものだけ抽出**
- **1回だけ再取得**（トークン切替リトライは従来通り）
- それでもダメなら `取得不可（再試行済）` として確定
※アカウント消失やID変更があるため、「無限再試行」はやらない
<details>
<summary>⑤ヘルスチェック（再発の早期検知）</summary>
- 12/21〜12/30 の件は修正済みだが、再発しても気づけないのが危険
- 例：その日の取得が一定割合未満なら Discord 通知等（0件は即アラート）
<details>
<summary>**（実行順の案）**</summary>
1. トリガー停止（整流と移行準備のため）
1. フォーム連携専用シート/運用・更新用シートの箱を作る（まだ同期しない）
1. 整流（運用・更新用シート初期データ作成）
1. 取得処理を運用・更新用シートへ接続（この瞬間が再開）
1. 取得不可ログ（最低限）
1. 単発再取得＋ヘルスチェック
<details>
<summary>（短期の完了条件）</summary>
- 運用・更新用シートが「1ユーザー=1行」になっている
- 取得不可が原因カテゴリ＋最終失敗日時で追える
- 当日取得率が見えて、閾値未達はアラートが飛ぶ
### 対策案（中期）
短期で一時的な対策は可能だが、スプシ/GASだけだと**“壊れない・追える・検知できる・復旧できる”**を仕組みとして担保しにくい。
そこで段階1として、DBを**履歴と監視の記録装置**にする。
<details>
<summary>（DBで担保できる品質）</summary>
1. **重複を物理的に防げる**（ユニーク制約）
1. **日次履歴を自然に積める**（縦持ちが標準）
1. **取得不可の理由と推移を管理できる**（エラーの種類, エラー日時 等）
1. **再試行や監視をジョブとして設計できる**（欠損を即検知）
<details>
<summary>DBで目指す状態</summary>
- 1ユーザー=1レコード（重複なし）
- 日次の取得結果が履歴として残る（後から追える）
- 取得不可が「原因カテゴリ」で見える（対応できる）
- 変更申請（フォーム未提出でも作る）を壊れずにデータ統合できる
<details>
<summary>現実的な進め方（段階移行）</summary>
1. DBを「履歴・監視の置き場」にする（取得処理はGASのまま）
- 段階1の成功条件：**取得率が見える／失敗が原因別に集計できる／欠損を当日アラートできる**
- DBに保存する最小機能：日次取得結果／失敗理由（カテゴリ＋HTTP等）／取得率集計
- 着手タイミング案：短期①〜②が固まったら並行で着手（監視が早く効くため）
1. DBを正に寄せる（Sheetsはビュー/UI）
1. 取得処理をサーバへ移す（安定運用・監視・再試行が本命）
### 相談したい判断ポイント
<details>
<summary>短期</summary>
- 入力と更新の分離をやるか（フォーム連携×GAS競合の事故リスクを潰す）
- データ整流（停止→人力で整える）を短期作業に含めるか
- 取得不可のエラー理由可視化をどこまでやるか（最低限：原因カテゴリ＋最終失敗日時）
- 「当日分」について全件走査後に空欄だけ1回再取得を入れるか（無限再試行はしない）
<details>
<summary>中期</summary>
- DB移行は段階1（履歴・監視）から始める方針で良いか（“DBを正にする”のではなく、まずは欠損を当日検知できる状態を作る）
- 段階1のスコープを「取得結果の履歴＋取得率の監視（アラート）」までに限定して良いか（取得処理は当面GASのまま）
### 付録：プロフィール画像の扱い（軽量化の論点）
- 現状：D列に `HYPERLINK + IMAGE` を書き込んでおり、**シートが重くなる要因**になりうる
- 目的：基本は「リンクで飛べれば十分」なら、画像**は削除候補**
- 判断したいこと：
- 画像は運用上、本当に必要か？（必要なら、代替：リンクのみ / 別シートに分離 / 表示用だけに限定 など）
- **残す条件**：画像がないとオペレーションが回らない（例：本人確認・アカウント識別で毎回必要）
- **消す条件**：リンクで十分／速度や容量が問題／運用上の価値が低い


---

## 子要素一覧

(子要素なし)

---
*Generated: 2026-01-14 12:09*
